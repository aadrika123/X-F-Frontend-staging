import{e as Oe,d as Me,b,m as F,Q as j,S as ze,p as Ee,j as n,f as Ae}from"./index-kYvQrdAy.js";import{P as qe}from"./index-Tu22Ztkr.js";import{e as Ge,d as Se,r as z}from"./router-vSHQYlWC.js";import{u as Ke}from"./formik.esm-feHG9Gj_.js";import{c as Qe,a as w}from"./index.esm-YegZWto1.js";import{F as We}from"./FormProvider-x5BP7G2z.js";import{T as N}from"./TextField-Q0rgLMVG.js";import{S as T}from"./SelectField-qex64B-S.js";import{T as _e}from"./TextAreaField-igAPd1pg.js";import"./TranslateField-jSRUiH4-.js";import{r as Ye}from"./resizeImage-8aUoMhTr.js";import{r as C}from"./tailwind-nPCoKmcy.js";import{u as $e}from"./reactQuery-xwoMMF6K.js";import"./axios-lPgvryBG.js";import"./reactIcons-jqXmw8S_.js";import"./headlessui-kWR29u24.js";import"./customInputValidation-jhKsg103.js";function Je({getConsumerDtl:l,getDemandDtl:u,id:s,shopDetails:c}){var _,D,P,B,R,O,M,E,q,G,K,Q,W,Y,$,J,L,U,Z,H,X,v,ee,ae,ne,te,de,re,oe,ie,ce,le,se,me,pe,xe,ge,Ne,he,fe,ue,be,je,ye,Ie,we,Fe,Ve;Ge();const{coords:f,isGeolocationEnabled:y,isGeolocationAvailable:I}=Oe(),De=Me({}),[Le,Pe]=Se.useState(null),[A,S]=Se.useState(!1),x=b({api:F.shopMaster,config:{},options:{enabled:!0}}),m=e=>{var d,t,r;return(r=(t=(d=c==null?void 0:c.data)==null?void 0:d.data)==null?void 0:t.shopDetails)==null?void 0:r.filter(i=>(i==null?void 0:i.key)===e)},V=(P=(D=(_=x==null?void 0:x.data)==null?void 0:_.data)==null?void 0:D.shopType)==null?void 0:P.find(e=>{var d,t;return(e==null?void 0:e.shop_type)==((t=(d=m("shopType"))==null?void 0:d[0])==null?void 0:t.value)}),k=(O=(R=(B=x==null?void 0:x.data)==null?void 0:B.data)==null?void 0:R.circleList)==null?void 0:O.find(e=>{var d,t;return(e==null?void 0:e.circle_name)==((t=(d=m("zone"))==null?void 0:d[0])==null?void 0:t.value)}),a=Ke({enableReinitialize:!0,initialValues:{shopId:s||0,amcShopNo:(E=(M=m("amcShopNo"))==null?void 0:M[0])==null?void 0:E.value,shopCategoryId:(V==null?void 0:V.id)||"",shopCategoryName:(G=(q=m("shopType"))==null?void 0:q[0])==null?void 0:G.value,circleId:(k==null?void 0:k.id)||"",circleName:(Q=(K=m("zone"))==null?void 0:K[0])==null?void 0:Q.value,marketId:"",marketName:(Y=(W=m("marketName"))==null?void 0:W[0])==null?void 0:Y.value,mobile_no:(J=($=m("contactNo"))==null?void 0:$[0])==null?void 0:J.value,alloteeName:(U=(L=m("allotteeName"))==null?void 0:L[0])==null?void 0:U.value,shopOwnerName:(H=(Z=m("ownerName"))==null?void 0:Z[0])==null?void 0:H.value,arrearDemand:(v=(X=c==null?void 0:c.data)==null?void 0:X.data)==null?void 0:v.arrearDemand,currentDemands:(ae=(ee=c==null?void 0:c.data)==null?void 0:ee.data)==null?void 0:ae.currentDemand,totalDemand:(te=(ne=c==null?void 0:c.data)==null?void 0:ne.data)==null?void 0:te.pendingAmount,latitude:"",longitude:"",document:"",remarks:"",citizenComment:""},validationSchema:Qe().shape({latitude:w().required("Latitude is required"),longitude:w().required("Longitude is required"),document:w().required("Document is required"),remarks:w().required("Remark is required")}),onSubmit:async(e,{resetForm:d})=>{if(!y)return j.error("Please enable location service");const t=new FormData;t.append("shopId",e==null?void 0:e.shopId),t.append("amcShopNo",e==null?void 0:e.amcShopNo),t.append("shopCategoryId",e==null?void 0:e.shopCategoryId),t.append("shopCategoryName",e==null?void 0:e.shopCategoryName),t.append("circleId",e==null?void 0:e.circleId),t.append("circleName",e==null?void 0:e.circleName),t.append("marketId",e==null?void 0:e.marketId),t.append("marketName",e==null?void 0:e.marketName),t.append("mobile_no",e==null?void 0:e.mobile_no),t.append("alloteeName",e==null?void 0:e.alloteeName),t.append("shopOwnerName",e==null?void 0:e.shopOwnerName),t.append("arrearDemand",e==null?void 0:e.arrearDemand),t.append("currentDemands",e==null?void 0:e.currentDemands),t.append("totalDemand",e==null?void 0:e.totalDemand),t.append("lat",e==null?void 0:e.latitude),t.append("lan",e==null?void 0:e.longitude),t.append("document",e==null?void 0:e.document),t.append("tcRemark",e==null?void 0:e.remarks),t.append("location","Ranchi"),t.append("citizenRemark",e==null?void 0:e.citizenComment),ze.fire({title:"Are you sure?",text:"\n          You are going to submit the application for the visit. Please make sure all the details are correct.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, Proceed!",cancelButtonText:"No, cancel!",reverseButtons:!0}).then(async r=>{var i,g,ke,Te,Ce;if(r.isConfirmed)try{const p=await De.mutateAsync({api:F.addTcVisit,data:t});(i=p==null?void 0:p.data)!=null&&i.status?(j.success((g=p==null?void 0:p.data)==null?void 0:g.message),d()):j.error((ke=p==null?void 0:p.data)==null?void 0:ke.message)}catch(p){j.error((Ce=(Te=p==null?void 0:p.response)==null?void 0:Te.data)==null?void 0:Ce.message)}}).catch(r=>{var i,g;console.log(r),j.error((g=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:g.message)})}}),o=b({api:F.listWiseCircleMarket,key:"marketList",config:{circleId:(de=a==null?void 0:a.values)==null?void 0:de.circleId},value:[(re=a==null?void 0:a.values)==null?void 0:re.circleId],options:{enabled:!!((oe=a==null?void 0:a.values)!=null&&oe.circleId),onSuccess:e=>{var d;((d=e==null?void 0:e.data)==null?void 0:d.length)>0?S(!0):S(!1)}}});z.useEffect(()=>{var e,d,t;A&&(a==null||a.setFieldValue("marketId",(t=(d=(e=o==null?void 0:o.data)==null?void 0:e.data)==null?void 0:d.find(r=>{var i,g;return(r==null?void 0:r.market_name)==((g=(i=m("marketName"))==null?void 0:i[0])==null?void 0:g.value)}))==null?void 0:t.id))},[A]);const Be=(le=(ce=(ie=o==null?void 0:o.data)==null?void 0:ie.data)==null?void 0:ce.find(e=>{var d,t;return(e==null?void 0:e.market_name)==((t=(d=m("marketName"))==null?void 0:d[0])==null?void 0:t.value)}))==null?void 0:le.id;console.log("marketListId",Be),z.useEffect(()=>{s||(a.setFieldValue("amcShopNo",""),a.setFieldValue("shopCategoryId",""),a.setFieldValue("shopCategoryName",""),a.setFieldValue("circleId",""),a.setFieldValue("circleName",""),a.setFieldValue("marketId",""),a.setFieldValue("marketName",""),a.setFieldValue("mobile_no",""),a.setFieldValue("alloteeName",""),a.setFieldValue("shopOwnerName",""),a.setFieldValue("arrearDemand",""),a.setFieldValue("currentDemands",""),a.setFieldValue("totalDemand",""),a.setFieldValue("latitude",""),a.setFieldValue("longitude",""),a.setFieldValue("document",""),a.setFieldValue("remarks",""),a.setFieldValue("citizenComment",""))},[!s]);const{values:h}=a;b({api:Ee.getWardByZone,config:{zoneId:h==null?void 0:h.zoneId},value:[h==null?void 0:h.zoneId],options:{enabled:!!(h!=null&&h.zoneId)}});const Re=async e=>{var r,i,g;if(!((r=e.target)!=null&&r.files[0]))return;await((i=window==null?void 0:window.ReactNativeWebView)==null?void 0:i.postMessage(JSON.stringify({Key:"OPEN_CAMERA"})));const d=await Ye(e.target.files[0]),t=new File([d],(g=e.target.files[0])==null?void 0:g.name,{type:"image/*"});a.setFieldValue("latitude",f==null?void 0:f.latitude),a.setFieldValue("longitude",f==null?void 0:f.longitude),a.setFieldValue("document",t),Pe(t)};return n.jsx(C.Card,{children:n.jsx(C.CardBody,{color:"blue",children:n.jsxs(We,{formik:a,children:[n.jsx("div",{className:"p-2",children:n.jsxs("div",{className:"row",children:[n.jsxs("div",{className:"col-md-6",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx("div",{className:"col-span-2",children:n.jsx(N,{name:"amcShopNo",label:"AMC Shop No",formik:a})}),n.jsx("div",{children:n.jsxs(T,{label:"Shop category",name:"shopCategoryId",formik:a,selectedText:"shopCategoryName",children:[n.jsx("option",{value:"",children:"select"}),(pe=(me=(se=x==null?void 0:x.data)==null?void 0:se.data)==null?void 0:me.shopType)==null?void 0:pe.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.shop_type},e==null?void 0:e.id))]})}),n.jsx("div",{children:n.jsxs(T,{label:"Zone",name:"circleId",selectedText:"circleName",formik:a,children:[n.jsx("option",{value:"",children:"select"}),(Ne=(ge=(xe=x==null?void 0:x.data)==null?void 0:xe.data)==null?void 0:ge.circleList)==null?void 0:Ne.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.circle_name},e==null?void 0:e.id))]})}),n.jsxs("div",{className:"col-span-2",children:[n.jsxs(T,{label:"Market",formik:a,name:"marketId",selectedText:"marketName",disabled:o==null?void 0:o.isLoading,children:[n.jsx("option",{value:"",children:"select"}),(fe=(he=o==null?void 0:o.data)==null?void 0:he.data)==null?void 0:fe.map(e=>n.jsx("option",{value:e==null?void 0:e.id,children:e==null?void 0:e.market_name},e==null?void 0:e.id))]}),n.jsx("small",{className:"text-blue-500",children:(o==null?void 0:o.isLoading)&&"Please wait..."})]})]}),n.jsx(N,{name:"mobile_no",label:"Mobile no",formik:a,disabled:s}),n.jsx(N,{name:"alloteeName",label:"Allotee Name",formik:a,disabled:s&&((be=(ue=m("allotteeName"))==null?void 0:ue[0])==null?void 0:be.value)}),n.jsx(N,{name:"shopOwnerName",label:"Shop Owner Name",formik:a,disabled:s&&((ye=(je=m("shopOwnerName"))==null?void 0:je[0])==null?void 0:ye.value)}),n.jsx(N,{name:"arrearDemand",label:"Arrear Demand",formik:a}),n.jsx(N,{name:"currentDemands",label:"Current Demand",formik:a,disabled:s&&((we=(Ie=l==null?void 0:l.data)==null?void 0:Ie.data)==null?void 0:we.address)})]}),n.jsxs("div",{className:"col-md-6",children:[n.jsx(N,{name:"totalDemand",label:"Total Demand",formik:a,disabled:s&&((Ve=(Fe=l==null?void 0:l.data)==null?void 0:Fe.data)==null?void 0:Ve.consumer_no)}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{className:"col-span-2",children:[n.jsx(N,{label:"Document",type:"file",name:"document",accept:"image/*",onChange:e=>{if(!y||!I){e.target.value=null,ze.fire({title:"Location Service",text:"Please enable location service",icon:"warning",confirmButtonText:"Ok",reverseButtons:!0});return}Re(e)}}),a.errors.document&&a.touched.document?n.jsx("small",{className:"text-red-500 -mt-2",children:a.errors.document}):null]}),n.jsx("div",{children:n.jsx(N,{name:"latitude",label:"Latitude",formik:a,disabled:!0})}),n.jsx("div",{children:n.jsx(N,{name:"longitude",label:"Longitude",formik:a,disabled:!0})})]}),n.jsx(_e,{name:"remarks",label:"Remarks",formik:a}),n.jsx(_e,{name:"citizenComment",label:"Citizen Comment",formik:a})]})]})}),n.jsx("div",{className:"flex justify-center",children:n.jsx(C.Button,{size:"sm",type:"submit",className:"btn btn-primary",children:"Submit"})})]})})})}function pa(){var I;const l=$e(),u=new URLSearchParams(window.location.search),s=u.get("shop-id"),c=b({api:Ae.waterGetDetails,key:"waterVisitDetail",config:{applicationId:u.get("id")},options:{enabled:!!u.get("id")}}),f=b({api:Ae.waterListDemand,key:"waterVisitListDemand",config:{ConsumerId:u.get("id")},options:{enabled:!!u.get("id")}}),y=b({api:(I=F)==null?void 0:I.shopDetailById,config:{id:s},options:{enabled:!!s}});return z.useEffect(()=>{s||(l==null||l.removeQueries({queryKey:"waterVisitDetail",exact:!0}),l==null||l.removeQueries({queryKey:"waterVisitListDemand",exact:!0}))},[!s]),n.jsx(qe,{title:"Market Visiting",children:n.jsx("div",{className:"p-2",children:n.jsx(Je,{getConsumerDtl:c,getDemandDtl:f,id:u.get("id"),shopDetails:y})})})}export{pa as default};
